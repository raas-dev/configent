#!/usr/bin/env bash

## shim for running `nerdctl` in lima VM

# shellcheck disable=SC2068  # not quoting parameters passed to the real bin
# shellcheck disable=SC2155  # will not declare separately, value compactness

: "${VM:="rancher"}"

if [[ "$OSTYPE" = darwin* ]]; then
  if ! limactl shell "$VM" true &>/dev/null ; then
    limactl start "$HOME/local/etc/lima/$VM.yaml" --tty=false || \
      limactl start "$VM"
  fi
  # forward to the same script on the guest VM
  limactl shell "$VM" "$HOME/local/bin/nerdctl" $@
else
  if [[ -x "/usr/local/bin/nerdctl" ]] ; then
    export XDG_RUNTIME_DIR="/run/user/$(id -u)"
    "/usr/local/bin/nerdctl" $@
  else
    echo "${BASH_SOURCE:-$0}: nerdctl not found in this Linux system."
    exit 127
  fi
fi

