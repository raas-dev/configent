#!/bin/sh

# configent (https://github.com/raas-dev/configent)
# One command automated macOS/Linux laptop/VM/container bootstrapper.
#
# Copyright(C) 2016- Anssi SyrjÃ¤salo (http://a.syrjasalo.com)
# Licensed under GNU Lesser General Public License v3 (LGPL-3.0).

# Proposes git commit message generated with LLM and asks to commit

# shellcheck disable=SC2034  # some colors are unused
normal=$(tput sgr0)
bold=$(tput bold)
black=$(tput setaf 0)
red=$(tput setaf 1)
green=$(tput setaf 2)
yellow=$(tput setaf 3)
blue=$(tput setaf 4)
magenta=$(tput setaf 5)
cyan=$(tput setaf 6)
white=$(tput setaf 7)

if ! command -v goose >/dev/null; then
  printf "%sError: goose not found in the system.\n" "$red"
  exit 127
fi

git_diff="$(git diff --staged --no-color)" || {
  printf "%sError: Failed to get git diff.\n" "$red"
  exit 1
}
if [ -z "$git_diff" ]; then
  printf "%sNothing staged to commit.\n" "$red"
  exit 1
fi

system_instructions_path="$HOME/.config/configent/prompts/commit.md"
if [ ! -f "$system_instructions_path" ]; then
  printf "%sError: System instructions file not found: %s\n" "$red" "$system_instructions_path"
  exit 1
fi

user_message="GIT DIFF: $git_diff"
if [ -n "$*" ]; then
  user_message="ADDITIONAL HINTS for type and scope: $*

$user_message"
fi

system_prompt="$(cat "$system_instructions_path")" || {
  printf "%sError: Failed to read system instructions file.\n" "$red"
  exit 1
}

commit_message="$(goose run --quiet \
  --no-session \
  --system "$system_prompt" \
  --text "$user_message")" || {
  printf "%sError: Failed to generate commit message.\n" "$red"
  exit 1
}

if [ -z "$commit_message" ]; then
  printf "%sError: Generated commit message is empty.\n" "$red"
  exit 1
fi

printf "%s$commit_message" "$white"
printf "\n"

if [ -z "$NONINTERACTIVE" ]; then
  printf "\n%sCommit with this (y), edit message first (e), or quit (q)\
  [y\\\e\\\q] %s> " "${bold}${cyan}" "$normal"
  read -r choice
else
  choice="y"
fi

case "$choice" in
[yY])
  git commit --message "$commit_message" || {
    printf "%sError: Failed to commit changes.\n" "$red"
    exit 1
  }
  printf "%sSuccessfully committed!\n" "$green"
  ;;
[eE])
  git commit --edit --message "$commit_message" || {
    printf "%sError: Failed to commit changes after editing.\n" "$red"
    exit 1
  }
  printf "%sSuccessfully committed!\n" "$green"
  ;;
*)
  printf "Aborted.\n"
  exit 1
  ;;
esac
