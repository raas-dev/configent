#!/bin/sh

# configent (https://github.com/raas-dev/configent)
# One command automated macOS/Linux laptop/VM/container bootstrapper.
#
# Copyright(C) 2016- Anssi SyrjÃ¤salo (http://a.syrjasalo.com)
# Licensed under GNU Lesser General Public License v3 (LGPL-3.0).

# Proposes git commit message generated with LLM and asks to commit

# shellcheck disable=SC2034  # some colors are unused

### constants ##################################################################

normal=$(tput sgr0)
bold=$(tput bold)
black=$(tput setaf 0)
red=$(tput setaf 1)
green=$(tput setaf 2)
yellow=$(tput setaf 3)
blue=$(tput setaf 4)
magenta=$(tput setaf 5)
cyan=$(tput setaf 6)
white=$(tput setaf 7)

### variables ##################################################################

: "${MODEL:="anthropic/claude-sonnet-4-5"}"

################################################################################

if ! command -v opencode >/dev/null; then
  printf "%sError: opencode not found in the system.\n" "$red"
  exit 127
fi

git_diff="$(git diff --staged --no-color)" || {
  printf "%sError: Failed to get git diff.\n" "$red"
  exit 1
}
if [ -z "$git_diff" ]; then
  printf "%sNothing staged to commit.\n" "$red"
  exit 1
fi

# Store git diff in temporary file to avoid "Argument list too long" error
diff_file=$(mktemp) || {
  printf "%sError: Failed to create temporary file.\n" "$red"
  exit 1
}
trap 'rm -f "$diff_file"' EXIT INT TERM
printf '%s' "$git_diff" >"$diff_file"

# Build context message (without git diff)
context_message=""
recent_headlines="$(git log --format="%s" -10 2>/dev/null | head -20)"
if [ -n "$recent_headlines" ]; then
  context_message="RECENT COMMIT MESSAGE HEADLINES FOR REFERENCE:
$recent_headlines"
fi

if [ -n "$*" ]; then
  if [ -n "$context_message" ]; then
    context_message="$context_message

ADDITIONAL CONSTRAINTS FOR TYPE AND SCOPE: $*"
  else
    context_message="ADDITIONAL CONSTRAINTS FOR TYPE AND SCOPE: $*"
  fi
fi

# The commit command reads the git diff from stdin
if [ -n "$context_message" ]; then
  commit_message="$(printf '%s\n\n%s' "$context_message" "$(cat "$diff_file")" | opencode run \
    --agent chat \
    --model "$MODEL" \
    --command commit)" || {
    printf "%sError: Failed to generate commit message.\n" "$red"
    exit 1
  }
else
  commit_message="$(cat "$diff_file" | opencode run \
    --agent chat \
    --model "$MODEL" \
    --command commit)" || {
    printf "%sError: Failed to generate commit message.\n" "$red"
    exit 1
  }
fi

if [ -z "$commit_message" ]; then
  printf "%sError: Generated commit message is empty.\n" "$red"
  exit 1
fi

printf "%s$commit_message" "$white"
printf "\n"

if [ -z "$NONINTERACTIVE" ]; then
  printf "\n%sCommit with this (y), edit message first (e), or quit (q)\
  [y\\\e\\\q] %s> " "${bold}${cyan}" "$normal"
  # Allow Ctrl+C to work during read
  trap 'printf "\n"; exit 130' INT
  read -r choice || {
    printf "\n"
    exit 130
  }
  trap - INT
else
  choice="y"
fi

case "$choice" in
[yY])
  git commit --message "$commit_message" || {
    printf "%sError: Failed to commit changes.\n" "$red"
    exit 1
  }
  ;;
[eE])
  git commit --edit --message "$commit_message" || {
    printf "%sError: Failed to commit changes after editing.\n" "$red"
    exit 1
  }
  ;;
*)
  printf "Aborted.\n"
  exit 1
  ;;
esac
