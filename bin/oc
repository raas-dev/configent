#!/bin/bash

# Switch OpenCode configuration profiles

# Based on:
# https://github.com/AnPod/Switch-Omo-Config/blob/v1.09/switch-omo-config.sh

CENTRAL_CONFIG_DIR="$HOME/.config/opencode"
PROFILES_DIR="$CENTRAL_CONFIG_DIR/profile"
PROJECT_ROOT_DIR="$PWD"
PROJECT_CONFIG_DIR="$PROJECT_ROOT_DIR/.opencode"

if [[ ! -d "$PROJECT_CONFIG_DIR" ]]; then
  # Prompt to create .opencode if it doesn't exist
  echo "No .opencode directory detected in current directory: $PROJECT_ROOT_DIR"
  read -r -p "Create .opencode directory here for project-scope configuration? [Y/n] " create_opencode
  if [[ ! "$create_opencode" =~ ^[Nn]$ ]]; then
    if ! mkdir -p "$PROJECT_CONFIG_DIR" 2>/dev/null; then
      echo "Error: Failed to create $PROJECT_CONFIG_DIR (check permissions)"
      exit 1
    fi
  else
    exit 0
  fi
fi

# Colors
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
DIM='\033[2m'
BOLD='\033[1m'
NC='\033[0m' # No Color

PROFILE_METADATA_FILE="$PROJECT_CONFIG_DIR/oc.json"

# Calculate hash of all files in a directory
calculate_profile_hash() {
  local profile_dir="$1"
  local combined_hash=""

  # Sort files and calculate combined hash
  while IFS= read -r file; do
    if [[ -f "$file" ]]; then
      combined_hash+=$(md5 -q "$file" 2>/dev/null)
    fi
  done < <(find "$profile_dir" -maxdepth 1 -type f | sort)

  # Return hash of the combined hashes
  echo "$combined_hash" | md5
}

# Save profile metadata
save_profile_metadata() {
  local profile_name="$1"
  local profile_dir="$2"

  local current_timestamp
  current_timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)

  local origin_hash
  origin_hash=$(calculate_profile_hash "$profile_dir")

  cat >"$PROFILE_METADATA_FILE" <<EOF
{
  "name": "$profile_name",
  "source": "$profile_dir",
  "updated_at": "$current_timestamp",
  "origin_hash": "$origin_hash"
}
EOF
}

# Load profile metadata
load_profile_metadata() {
  if [[ ! -f "$PROFILE_METADATA_FILE" ]]; then
    echo ""
    return
  fi

  # Extract profile name from JSON
  grep -o '"name"[[:space:]]*:[[:space:]]*"[^"]*"' "$PROFILE_METADATA_FILE" | cut -d'"' -f4
}

# Get list of profile directories
get_configs() {
  find -L "$PROFILES_DIR" -maxdepth 1 -mindepth 1 -type d | sort
}

# Get current active profile by checking metadata file first, then comparing files
get_current() {
  # First, check if metadata file exists and is valid
  local metadata_profile
  metadata_profile=$(load_profile_metadata)

  if [[ -n "$metadata_profile" ]]; then
    # If metadata profile directory exists, return it (trust the metadata)
    local metadata_dir="$PROFILES_DIR/$metadata_profile"
    if [[ -d "$metadata_dir" ]]; then
      echo "$metadata_profile"
      return
    fi
  fi

  # If metadata is invalid or missing, find which profile directory matches the current project config
  while IFS= read -r profile_dir; do
    local profile_name
    profile_name=$(basename "$profile_dir")
    local all_match=true

    # Check if all files in the profile match those in the project
    for profile_file in "$profile_dir"/*; do
      if [[ ! -f "$profile_file" ]]; then
        continue
      fi
      local filename
      filename=$(basename "$profile_file")
      local project_file="$PROJECT_CONFIG_DIR/$filename"

      if [[ ! -f "$project_file" ]]; then
        all_match=false
        break
      fi

      local profile_hash
      profile_hash=$(md5 -q "$profile_file" 2>/dev/null)
      local project_hash
      project_hash=$(md5 -q "$project_file" 2>/dev/null)
      if [[ "$profile_hash" != "$project_hash" ]]; then
        all_match=false
        break
      fi
    done

    if [[ "$all_match" == "true" ]]; then
      echo "$profile_name"
      return
    fi
  done < <(get_configs)
  echo ""
}

# Interactive menu with arrow keys
show_menu() {
  local configs=()
  local names=()

  while IFS= read -r file; do
    configs+=("$file")
    names+=("$(basename "$file")")
  done < <(get_configs)

  if [[ ${#configs[@]} -eq 0 ]]; then
    echo -e "${YELLOW}No profile directories found in $PROFILES_DIR${NC}" >&2
    exit 1
  fi

  local current
  current=$(get_current)
  local selected=0
  local total=${#configs[@]}

  # Find and select the currently active configuration by default
  if [[ -n "$current" ]]; then
    for i in "${!names[@]}"; do
      if [[ "${names[$i]}" == "$current" ]]; then
        selected=$i
        break
      fi
    done
  fi

  # Hide cursor
  tput civis

  # Cleanup on exit
  trap 'tput cnorm; echo' EXIT TERM

  echo -e "${BOLD}Select OpenCode configuration${NC}"
  echo -e "${DIM}Use arrow keys to navigate, Enter to select, q to quit${NC}"
  echo ""

  while true; do
    # Move cursor up to redraw menu
    if [[ $REPLY ]]; then
      tput cuu "$total"
    fi

    # Draw menu
    for i in "${!names[@]}"; do
      local name="${names[$i]}"
      local marker="  "
      local color=""
      local suffix=""

      # Check if this is the currently active config
      if [[ "$name" == "$current" ]]; then
        suffix=" ${GREEN}(active)${NC}"
      fi

      if [[ $i -eq $selected ]]; then
        marker="${YELLOW}>${NC} "
        color="${CYAN}"
        echo -e "${marker}${color}${name}${NC}${suffix}"
      else
        echo -e "  ${DIM}${name}${NC}${suffix}"
      fi
    done

    # Read single keypress
    read -rsn1 key

    # Handle arrow keys (escape sequences)
    if [[ $key == $'\x1b' ]]; then
      read -rsn2 key
      case $key in
      '[A') # Up arrow
        ((selected--))
        [[ $selected -lt 0 ]] && selected=$((total - 1))
        ;;
      '[B') # Down arrow
        ((selected++))
        [[ $selected -ge $total ]] && selected=0
        ;;
      esac
    elif [[ $key == "" ]]; then # Enter
      break
    elif [[ $key == $'\x03' || $key == "q" || $key == "Q" ]]; then # ^C or q
      tput cnorm
      echo ""
      echo -e "${DIM}Cancelled.${NC}"
      exit 0
    elif [[ $key == "j" ]]; then # vim down
      ((selected++))
      [[ $selected -ge $total ]] && selected=0
    elif [[ $key == "k" ]]; then # vim up
      ((selected--))
      [[ $selected -lt 0 ]] && selected=$((total - 1))
    fi

    REPLY=1
  done

  # Show cursor
  tput cnorm

  # Copy selected profile
  local selected_profile_dir="${configs[$selected]}"
  local selected_name="${names[$selected]}"

  echo ""

  if [[ "$selected_name" == "$current" ]]; then
    # Check if the origin profile has been updated since it was last copied
    local metadata_file="$PROJECT_CONFIG_DIR/oc.json"
    if [[ -f "$metadata_file" ]]; then
      # Extract stored hash and source path from metadata
      local stored_hash
      stored_hash=$(grep -o '"origin_hash"[[:space:]]*:[[:space:]]*"[^"]*"' "$metadata_file" | cut -d'"' -f4)
      local source_path
      source_path=$(grep -o '"source"[[:space:]]*:[[:space:]]*"[^"]*"' "$metadata_file" | cut -d'"' -f4)

      # Calculate current hash of the origin profile
      local current_origin_hash
      current_origin_hash=$(calculate_profile_hash "$selected_profile_dir")

      # Only ask for reset if the origin profile hash has changed
      if [[ -n "$stored_hash" && "$stored_hash" != "$current_origin_hash" ]]; then
        local display_path
        display_path="${source_path/#$HOME/~}"
        echo -e "${YELLOW}$selected_name has been updated in the origin ($display_path).${NC}"
        echo -ne "${YELLOW}Reset from origin (overrides project-specific changes)? [y/N]${NC} "
        read -r reset_profile
        if [[ ! "$reset_profile" =~ ^[Yy]$ ]]; then
          echo -e "${DIM}Cancelled.${NC}"
          exit 0
        fi
      else
        local display_path
        display_path="${source_path/#$HOME/~}"
        echo -e "${DIM}$selected_name is already active.${NC}"
        echo -e "${DIM}There are no updates in the origin ($display_path).${NC}"
        exit 0
      fi
    fi
  fi

  # Remove conflicting files from the project config directory before copying
  for profile_file in "$selected_profile_dir"/*; do
    if [[ -f "$profile_file" ]]; then
      local filename
      filename=$(basename "$profile_file")
      local basename_no_ext="${filename%.*}"
      local ext="${filename##*.}"

      # Remove any files with the same basename but different extension
      for existing_file in "$PROJECT_CONFIG_DIR"/"$basename_no_ext".*; do
        if [[ -f "$existing_file" ]]; then
          local existing_ext="${existing_file##*.}"
          if [[ "$existing_ext" != "$ext" ]]; then
            rm -f "$existing_file"
          fi
        fi
      done
    fi
  done

  # Copy all files from the selected profile directory to the project config directory
  if cp "$selected_profile_dir"/* "$PROJECT_CONFIG_DIR/" 2>/dev/null; then
    # Save profile metadata
    save_profile_metadata "$selected_name" "$selected_profile_dir"

    echo -e "${GREEN}Switched to: ${BOLD}$selected_name${NC}"
    echo -e "${DIM}Copied profile files to: $PROJECT_CONFIG_DIR${NC}"
  else
    echo -e "${YELLOW}Error: Failed to copy profile files${NC}"
    exit 1
  fi
}

# Run
show_menu
