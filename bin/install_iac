#!/bin/sh

# configent (https://github.com/raas-dev/configent)
# One command automated macOS/Linux laptop/VM/container bootstrapper.
#
# Copyright(C) 2016- Anssi SyrjÃ¤salo (http://a.syrjasalo.com)
# Licensed under GNU Lesser General Public License v3 (LGPL-3.0).

# shellcheck disable=SC1091  # do not expect input files

trap "printf '\nCaught ^C from user - exiting now\n' ; exit 130" INT

### asdf #######################################################################

. "$HOME/.asdf/asdf.sh"

### brew #######################################################################

eval_brew() {
  if [ -x "/opt/homebrew/bin/brew" ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  elif [ -x "/usr/local/bin/brew" ]; then
    eval "$(/usr/local/bin/brew shellenv)"
  elif [ -x "/home/linuxbrew/.linuxbrew/bin/brew" ]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
  elif [ -x "$HOME/.linuxbrew/bin/brew" ]; then
    eval "$("$HOME"/.linuxbrew/bin/brew shellenv)"
  fi
}
eval_brew

if ! command -v brew >/dev/null; then
  NONINTERACTIVE=true HOMEBREW_INSTALL_FROM_API=true \
    bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
  eval_brew
fi

### aws ########################################################################

asdf plugin add awscli
asdf install awscli

asdf plugin add aws-vault
asdf install aws-vault

### azure ######################################################################

asdf plugin add azure-cli
asdf install azure-cli

az config set core.collect_telemetry=false
az config set core.output=jsonc

az bicep install
az extension add --name azure-devops --upgrade --yes
az extension add --name containerapp --upgrade --yes
az extension add --name next --upgrade --yes

### azure developer cli ########################################################

mkdir -p "$HOME/.azd/bin"
# nosemgrep
curl -fsSL https://aka.ms/install-azd.sh | AZURE_DEV_COLLECT_TELEMETRY=no \
  bash -s -- --install-folder "$HOME/.azd" --symlink-folder "$HOME/.azd/bin"

### terraform ##################################################################

asdf plugin add terraform
asdf install terraform

asdf plugin add tfsec
asdf install tfsec

### k8s ########################################################################

asdf plugin add kubectl
asdf install kubectl

asdf plugin add krew
asdf install krew

kubectl krew install ctx
kubectl krew install ns

asdf plugin add helm
asdf install helm

asdf plugin add k9s
asdf install k9s

### cloudflare #################################################################

asdf plugin add cloudflared
asdf install cloudflared
