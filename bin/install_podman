#!/bin/sh

# configent (https://github.com/raas-dev/configent)
# One command automated macOS/Linux laptop/VM/container bootstrapper.
#
# Copyright(C) 2016- Anssi SyrjÃ¤salo (http://a.syrjasalo.com)
# Licensed under GNU Lesser General Public License v3 (LGPL-3.0).

trap "printf '\nCaught ^C from user - exiting now\n' ; exit 130" INT

if [ "$(id -u)" = 0 ]; then
  SUDO=''
  export DEBIAN_FRONTEND=noninteractive
elif command -v sudo >/dev/null; then
  SUDO='sudo DEBIAN_FRONTEND=noninteractive'

  # Ask sudo password upfront
  sudo -n true || sudo -v

  # Keep sudo alive until the script has finished
  while true; do
    sudo -n true
    sleep 60
    kill -0 "$$" || exit
  done 2>/dev/null &
else
  printf "\nERROR: User is non-root and sudo not available, cannot proceed.\n"
  exit 1
fi

# Update package lists
$SUDO apt-get update

# Ensure apt-get sources.list works with https
$SUDO apt-get install -y apt-transport-https ca-certificates

# gpg
$SUDO apt-get install -y gnupg

# Setup systemd socket configuration for rootless podman
$SUDO mkdir -p /etc/systemd/system/podman.socket.d
if [ ! -e /etc/systemd/system/podman.socket.d/override.conf ]; then
  echo "[Socket]
SocketUser=$USER" | $SUDO tee /etc/systemd/system/podman.socket.d/override.conf >/dev/null
fi

# Setup tmpfiles.d for podman
if [ ! -e /etc/tmpfiles.d/podman.conf ]; then
  $SUDO mkdir -p /etc/tmpfiles.d
  echo "d /run/podman 0700 $USER -" | $SUDO tee /etc/tmpfiles.d/podman.conf >/dev/null
fi

# Install podman
$SUDO apt-get install -y podman

# Install crun (OCI runtime) - fixes Ubuntu Podman conmon bug
$SUDO apt-get install -y crun

# Configure crun as default runtime for Ubuntu Podman
$SUDO mkdir -p /etc/containers
if [ ! -e /etc/containers/containers.conf ] || ! grep -q '^runtime = "crun"' /etc/containers/containers.conf; then
  cat <<EOF | $SUDO tee /etc/containers/containers.conf >/dev/null
[engine]
runtime = "crun"
EOF
fi

# Configure registries to allow short names
if [ -e /etc/containers/registries.conf ]; then
  # Add unqualified-search-registries if not present
  if ! grep -q "^unqualified-search-registries" /etc/containers/registries.conf; then
    echo 'unqualified-search-registries = ["docker.io"]' | $SUDO tee -a /etc/containers/registries.conf >/dev/null
  fi
  # Disable short-name enforcing mode
  $SUDO sed -i 's/short-name-mode = "enforcing"/short-name-mode = "disabled"/g' /etc/containers/registries.conf
fi

# Enable and start podman.socket for the user
systemctl --user enable --now podman.socket
