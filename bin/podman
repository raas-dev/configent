#!/bin/sh

# configent (https://github.com/raas-dev/configent)
# One command automated macOS/Linux laptop/VM/container bootstrapper.
#
# Copyright(C) 2016- Anssi SyrjÃ¤salo (http://a.syrjasalo.com)
# Licensed under GNU Lesser General Public License v3 (LGPL-3.0).

# shim for running `podman` in lima VM

# shellcheck disable=SC2068  # not quoting parameters passed to the real bin

: "${VM:="fedora"}"

if [ "$(uname -s)" = 'Darwin' ]; then
  if ! command -v limactl >/dev/null; then
    echo "Error: limactl not found on macOS, cannot run VM for Podman daemon."
    exit 127
  fi
  if [ "$(uname -m)" = 'arm64' ]; then
    local_podman_path="/opt/homebrew/bin/podman"
  else
    local_podman_path="/usr/local/bin/podman"
  fi
  if [ -x "$local_podman_path" ]; then
    if [ -z "$CONTAINER_HOST" ]; then
      # requires forwarding the socket in the lima vm config file
      export CONTAINER_HOST="unix://$HOME/.lima/$VM/sock/podman.sock"
    fi
    # homebrew installed podman
    "$local_podman_path" $@
  else
    # no podman cli on HOST -> recall this script on the guest VM
    if ! limactl shell "$VM" true >/dev/null 2>&1; then
      limactl start "$HOME/local/etc/lima/$VM.yaml" --tty=false ||
        limactl start "$VM"
    fi
    limactl shell "$VM" "$HOME/local/bin/podman" $@
  fi
else
  if [ -x "/usr/bin/podman" ]; then
    "/usr/bin/podman" $@
  else
    echo "Error: podman not found in this Linux system."
    exit 127
  fi
fi
