#!/bin/sh

# configent (https://github.com/raas-dev/configent)
# One command automated macOS/Linux laptop/VM/container bootstrapper.
#
# Copyright(C) 2016- Anssi Syrjäsalo (http://a.syrjasalo.com)
# Licensed under GNU Lesser General Public License v3 (LGPL-3.0).

### constants ##################################################################

socket_vmnet_src_dir="$HOME/.local/share/socket_vmnet"

### socket_vmnet ###############################################################

if [ "$(uname -s)" != "Darwin" ]; then
  echo "Skipping lima socket_vmnet setup: not on macOS."
  exit 0
fi

# Ask sudo password upfront
sudo -n true || sudo -v

git clone --depth 1 https://github.com/lima-vm/socket_vmnet \
  "$socket_vmnet_src_dir"

(cd "$socket_vmnet_src_dir" &&
  git fetch --tags &&
  latest_tag=$(git tag -l | sort -V | tail -1) &&
  git checkout "$latest_tag" &&
  make &&
  sudo make PREFIX=/opt/socket_vmnet install.bin &&
  sudo chmod -R a+rx /opt/socket_vmnet)

(
  cd "$socket_vmnet_src_dir" &&
    limactl sudoers >etc_sudoers.d_lima &&
    sudo install -o root etc_sudoers.d_lima /etc/sudoers.d/lima
  rm -f etc_sudoers.d_lima
)

# The IP address is automatically assigned by macOS’s bootpd.
# See: https://lima-vm.io/docs/config/network/vmnet/#socket_vmnet
#
# If the IP address is not assigned, try the following commands:
# sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /usr/libexec/bootpd
# sudo /usr/libexec/ApplicationFirewall/socketfilterfw --unblock /usr/libexec/bootpd
