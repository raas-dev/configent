#!/bin/bash
# the above shebang is purely for ShellCheck, this file is not executable

# shellcheck disable=SC2086  # not quoting args passed to docker run

### OS specific ################################################################

# Upgrade brew formulas, antidote and tmux plugins
alias br='command -v brew >/dev/null &&
  (brew update && brew upgrade ; brew autoremove) ;
  command -v antidote >/dev/null && antidote update ;
  [ -x "$HOME/.tmux/plugins/tpm/bin/update_plugins" ] &&
  $HOME/.tmux/plugins/tpm/bin/update_plugins all'

if [ "$(uname -s)" = 'Darwin' ]; then
  # Brew cask upgrade
  alias brc='brew cu --all --yes --no-quarantine --cleanup'

  # Install macOS application updates
  alias up='br ; brc'

  # Install macOS application and system updates
  alias dup='br ; brc ; softwareupdate --install --all --agree-to-license'

  # Recursively delete .DS_Store files in the current path
  alias cleanupds='/usr/bin/find . -type f -name "*.DS_Store" -ls -delete'

  # Clean up LaunchServices to remove duplicates in "Open With" menues
  alias cleanupls='/System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister \
    -kill -r -domain local -domain system -domain user &&
    killall Finder'

  # Fix broken icons in Dock
  alias reseticons="sudo /usr/bin/find /private/var/folders/ \
    -name com.apple.dock.iconcache -exec rm {} \; ;
    sudo /usr/bin/find /private/var/folders/ -name com.apple.iconservices -exec rm -rf {} \; ;
    sudo rm -rf /Library/Caches/com.apple.iconservices.store ;
    sleep 3 ;
    killall Dock ;
    killall Finder"

  # Fix macOS keyboard input sources
  alias resetkeyboard="rm -f ~/Library/Preferences/com.apple.HIToolbox.plist ;
    sudo rm -f /Library/Preferences/com.apple.HIToolbox.plist"

  # Disable or enable Spotlight (indexing)
  alias spotoff='sudo mdutil -a -i off'
  alias spoton='sudo mdutil -a -i on'

  # Canonical hex dump; some systems have this symlinked
  command -v hd >/dev/null || alias hd='hexdump -C'

  # macOS keychain
  get_keychain_variable() {
    local name="$1"
    [ -z "$name" ] && echo "Usage: get_keychain_variable <varname>" && return 1
    security find-generic-password -w \
      -a "$USER" -D "environment variable" -s "$name"
  }

  set_keychain_variable() {
    local name="$1"
    [ -z "$name" ] && echo "Usage: set_keychain_variable <varname>" && return 1
    printf "Enter secret for %s: " "$name"
    read -r secret
    [ -z "$secret" ] && echo "Error: Empty secret" && return 1
    security add-generic-password -U \
      -a "$USER" -D "environment variable" -s "$name" -w "$secret"
  }
else
  if command -v apt >/dev/null; then
    alias up='sudo apt update &&
      sudo apt upgrade -y && sudo apt autoremove -y && sudo apt clean ;
      br'
    alias dup='sudo apt update &&
      sudo apt full-upgrade -y && sudo apt autoremove -y && sudo apt clean ;
      br'
  elif command -v yum >/dev/null; then
    alias up='sudo yum update -y --exclude=kernel* && sudo yum autoremove -y ;
      br'
    alias dup='sudo yum update -y && sudo yum autoremove -y ;
      br'
  elif command -v yay >/dev/null; then
    alias up='yay --noconfirm -Suy &&
      yay -Qdtq | yay --noconfirm -Rs - ;
      br'
    alias dup='up'
  elif command -v pacman >/dev/null; then
    alias up='sudo pacman --noconfirm -Suy &&
      sudo pacman -Qdtq | sudo pacman --noconfirm -Rs - ;
      br'
    alias dup='up'
  elif command -v apk >/dev/null; then
    alias up='sudo apk update &&
      sudo apk add --upgrade apk-tools &&
      sudo apk upgrade ;
      br'
    alias dup='up'
  fi

  # Similar to macOS `pbcopy` and `pbpaste`
  alias pbcopy='xsel --clipboard --input'
  alias pbpaste='xsel --clipboard --output'

  # Similar to macOS `open`
  alias open='xdg-open'
fi

### More sensible defaults #####################################################

alias code='code --reuse-window --add'

alias grep='grep --color'
alias egrep='egrep --color'
alias fgrep='fgrep --color'

alias ping='ping -c 999'

### Safer defaults #############################################################

alias chown='chown --preserve-root'
alias chmod='chmod --preserve-root'
alias chgrp='chgrp --preserve-root'

### Enhanced ls ################################################################

if command -v lsd >/dev/null; then
  alias ls='lsd --group-dirs first --date="+%a %d-%b-%y %H:%M:%S" --icon never'
  alias la='ls -Al'
  alias le='ls -Al --extensionsort && echo Ordered by extension, alphabetically'
  alias lu='ls -Al --sizesort && echo Ordered by size, biggest first'
  alias lt='ls -Al --timesort && echo Ordered by change time, most recent first'
  alias lut='ls -Al --sizesort --total-size --tree --depth 2'
else
  alias ls='ls --color -h'
  alias la='ls -Al'
  alias le='ls -Al -XB && echo Ordered by extension, alphabetically'
  alias lu='ls -Al -S && echo Ordered by size, biggest first'
  alias lt='ls -Al -tc && echo Ordered by change time, most recent first'
fi

### Shortcuts ##################################################################

alias a='rg --smart-case --no-ignore --hidden --glob "!.git/"'
alias b='bat'
alias c='sgpt_code'
# d is for generic docker build and run, see d()
# e is for generic extract package, see e()
alias f='fd --ignore-case --no-ignore --hidden'
alias g='gitui'
alias h='xh'
alias i='glances'
# j is for zoxide
alias k='kalker'
alias l='la'
# m is for m-cli
alias n='nixery'
alias o='open'
alias p='procs --tree --watch-interval 1'
alias q='clear'
# r is for reloading shell's configuration (alias is in shell specific rc files)
alias s='sgpt_chat'
alias t='taillog'
alias u='diskonaut'
alias v='limactl'
alias w='which -a'
alias x='pkill -i -f'
alias y='cht.sh'
alias z='whatlistens'
alias ¨='bat --show-all --theme=default'
alias §='trans :fi'
alias ,='trans'
alias _='sgpt_shell'

### watch ######################################################################

command -v viddy >/dev/null && alias watch='viddy --differences'

### vim ########################################################################

command -v nvim >/dev/null && alias vim='nvim'

### Lima VMs ###################################################################

alias vm4rancher="limactl start \$HOME/local/etc/lima/rancher.yaml \
  --tty=false ;
  export KUBECONFIG=\$HOME/.lima/rancher/kubeconfig.yaml ;
  limactl shell rancher sudo cat /etc/rancher/k3s/k3s.yaml > \$KUBECONFIG ;
  kubectl get nodes"

alias vm4ubuntu="limactl start \$HOME/local/etc/lima/ubuntu.yaml --tty=false"
alias vm4debian="limactl start \$HOME/local/etc/lima/debian.yaml --tty=false"

alias vm4alma="limactl start \$HOME/local/etc/lima/almalinux.yaml --tty=false"
alias vm4centos="limactl start \$HOME/local/etc/lima/centos.yaml --tty=false"
alias vm4fedora="limactl start \$HOME/local/etc/lima/fedora.yaml --tty=false"
alias vm4rocky="limactl start \$HOME/local/etc/lima/rocky.yaml --tty=false"
alias vm4oracle="limactl start \$HOME/local/etc/lima/oraclelinux.yaml --tty=false"

alias vm4arch="limactl start \$HOME/local/etc/lima/archlinux.yaml --tty=false"
alias vm4alpine="limactl start \$HOME/local/etc/lima/alpine.yaml --tty=false"

### Docker #####################################################################

alias drmc='docker rm --force $(docker ps --all --quiet)'
alias drmv='docker volume rm --force $(docker volume ls --quiet)'
alias drmi='docker rmi --force $(docker images --all --quiet)'
alias dpr='drmc ; drmv ; drmi ; docker system prune --force --volumes'

# https://github.com/sigoden/dufs
alias dufs='docker run --init -it \
  --cap-drop ALL \
  --publish 127.0.0.1:80:80 \
  --volume $(pwd):/data \
  sigoden/dufs \
  /data -p 80'

### nerdctl ####################################################################

alias nrmc='nerdctl rm --force $(nerdctl ps --all --quiet)'
alias nrmv='nerdctl volume rm --force $(nerdctl volume ls --quiet)'
alias nrmi='nerdctl rmi $(nerdctl images --all --quiet)'
alias npr='nrmc ; nrmv ; nrmi'

alias netdata='nerdctl run -d --name=netdata \
  --publish 127.0.0.1:19999:19999 \
  --volume netdataconfig:/etc/netdata \
  --volume netdatalib:/var/lib/netdata \
  --volume netdatacache:/var/cache/netdata \
  --volume /etc/passwd:/host/etc/passwd:ro \
  --volume /etc/group:/host/etc/group:ro \
  --volume /proc:/host/proc:ro \
  --volume /sys:/host/sys:ro \
  --volume /etc/os-release:/host/etc/os-release:ro \
  --cap-add SYS_PTRACE \
  --security-opt apparmor=unconfined \
  netdata/netdata'

### Misc #######################################################################

# Copy the current path to clipboard
alias cwd='pwd | tr -d "\n" | pbcopy'

# Display public IP
alias ip='curl --silent --ipv4 https://ifconfig.co/json | jq .'
alias ipv6='curl --silent --ipv6 https://ifconfig.co/ip'

# Display PATH content
alias path='printf "${PATH//:/\\n}\n"'

# Enable aliases to be sudo’ed
alias sudo='sudo '

# Display week number
alias week='date +%V'

# Weather (https://wttr.in/:help)
alias wttr='curl "https://wttr.in?format=v2&MF"'

### Utilities ##################################################################

# OpenAI helpers
sgpt() {
  pipx run --spec=shell-gpt sgpt --no-cache "$@"
}

sgpt_chat() {
  sgpt --model gpt-4 --chat "$(date +"%Y-%m-%d"):chat$TMUX_PANE" "$*"
}

sgpt_code() {
  sgpt --temperature 0 --chat "$(date +"%Y-%m-%d"):code$TMUX_PANE" --code "$*"
}

sgpt_shell() {
  sgpt --temperature 0 --chat "$(date +"%Y-%m-%d"):shell$TMUX_PANE" --shell "$*"
}

# Generic docker build and run
d() {
  # shellcheck disable=SC2155  # will not declare separately, value compactness
  local name="$(echo "${PWD##*/}" | tr '[:upper:]' '[:lower:]')"
  if docker top "$name" &>/dev/null ; then
    docker stop "$name" || docker kill "$name"
  fi
  [ -r "$PWD/.env" ] && local env_file="--env-file $PWD/.env"
  local run_args="$*"
  docker build --pull --tag "$name" . &&
  docker run --init -it --detach --name "$name" --rm \
    --cap-drop ALL \
    --publish-all \
    --publish 127.0.0.1:8080:8080 \
    $env_file \
    $run_args \
    "$name" &&
  echo "[d] Published ports: container -> host"
  docker port "$name"
  echo "[d] Following logs, ^C does not halt the container"
  docker logs --follow "$name"
}

# Generic extract package
e() {
  if [ -r "$1" ]; then
    if command -v unar >/dev/null; then
      unar "$1"
    else
      case $1 in
        *.tar.bz2) tar xvjf "$1" ;;
        *.tar.gz) tar xvzf "$1" ;;
        *.bz2) bunzip2 "$1" ;;
        *.rar) unrar x "$1" ;;
        *.gz) gunzip "$1" ;;
        *.tar) tar xvf "$1" ;;
        *.tbz2) tar xvjf "$1" ;;
        *.tgz) tar xvzf "$1" ;;
        *.zip) unzip "$1" ;;
        *.Z) uncompress "$1" ;;
        *.7z) 7z x "$1" ;;
        *) echo "[e] Couldn't open archive '$1'" ;;
      esac
    fi
  else
    echo "[e] Couldn't read file '$1'"
  fi
}

# Follow the given log file, or cloud-init output if log file not given
taillog() {
  local log="${1:-"/var/log/cloud-init-output.log"}"
  if command -v lnav >/dev/null; then
    if [ -r "$log" ]; then
      lnav "$log"
    else
      sudo lnav "$log"
    fi
  else
    if [ -r "$log" ]; then
      tail --follow --verbose --lines=20 "$log"
    else
      sudo tail --follow --verbose --lines=20 "$log"
    fi
  fi
}

# List 20 biggest directories
usage() {
  du | sort -r -n |
    awk '{split("K M G",v); s=1; while($1>1024){$1/=1024; s++} \
      print int($1)" "v[s]"\t"$2}' | head -n 20
}

# Show process listening the given port
whatlistens() {
  local port="${1:-8080}"
  lsof -P -i :"$port" | column -t
}

# Generate password and copy it to clipboard
genpass() {
  local length="${1:-16}"
  tr </dev/urandom -dc 'a-zA-Z0-9-_!@#$%^&*()_+{}|:<>?=' |
    fold -w "$length" | head -n1 | pbcopy
}

# Remove all non-cask formulae
brewclear() {
  brew list --formula | xargs brew uninstall --ignore-dependencies --force
}

# Npm remove all global packages (except later npm installed via npm)
npmclear() {
  npm ls --location=global -p --depth=0 |
    awk -F/ '/node_modules/ && !/\/npm$/ {print $NF}' |
    xargs npm --location=global rm
}

# Gem remove all
gemclear() {
  gem uninstall -aIx
}

# Pip(x) remove all
pipclear() {
  command -v pipx >/dev/null && pipx uninstall-all
  pip freeze | grep -v "^-e" | cut -d "@" -f1 | xargs pip uninstall -y
}

### Latest version of Python command-line tools ################################

# cross-platform real-time monitoring
alias glances='pipx run "glances[action,browser,cloud,cpuinfo,docker,export,folders,gpu,graph,ip,raid,snmp,web,wifi]"'

# general media downloader
alias you-get='pipx run you-get'

# simplenote in terminal
alias sncli='pipx run sncli'

# jupyter notebooks in terminal
alias euporie='pipx run euporie'

# multitool for tabular data in terminal
alias vd='pipx run --pip-args openpyxl visidata'

# playwright
alias playwright='pipx run playwright'

# huggingface-cli
alias huggingface-cli='pipx run --spec huggingface-hub huggingface-cli'

# openai
alias openai='pipx run openai'

# aider
alias aider='pipx run aider-chat'

# gpt-engineer
alias gpt-engineer='pipx run gpt-engineer'

### Latest versions of global Node.js command-line tools #######################

# Find unused and missing package.json (dev)Dependencies
alias depcheck='npx -y depcheck'

# Upgrades your package.json dependencies to the latest version
alias ncu='npx -y npm-check-updates'

# project generator (uses bin/yarn)
alias projen='npx -y projen'

# Bump version and generate CHANGELOG.md
alias standard-version='npx -y standard-version'

# Identify technology on websites
alias wappalyzer='npx -y wappalyzer'

### Run nix in Docker ##########################################################

# nix.dev
nixd() {
  local name="${PWD##*/}"
  if [ -z "$1" ] ; then
    local args="bash"
  else
    local args="$*"
  fi
  docker start "$name" &>/dev/null || docker run --init -it --detach \
    --name "$name" \
    --publish-all \
    --volume="$PWD:$PWD" \
    --workdir="$PWD" \
    nixos/nix
  docker exec -it --workdir="$PWD" "$name" $args
}

alias nix='nixd nix'
alias nix-env='nixd nix-env'
alias nix-shell='nixd nix-shell'

# https://www.jetpack.io/devbox/
devbox() {
  local args="$*"
  if nixd [ ! -x /bin/bash ] ; then
    nixd ln -s /root/.nix-profile/bin/bash /bin/bash
  fi
  if nixd [ ! -x /usr/local/bin/devbox ]; then
    nixd curl -fsSL https://get.jetpack.io/devbox -o /tmp/devbox_install
    nixd chmod +x /tmp/devbox_install
    nixd /tmp/devbox_install --force
    nixd ln -s /usr/local/bin/devbox /root/.nix-profile/bin/devbox
  fi
  nixd devbox $args
}

### Binaries within Docker built dynamically by nixery #########################

# nixery.dev
nixery() {
  [ -z "$1" ] && echo "Usage: $0 nix-pkg1[/nix-pkgN] [COMMAND]" && return
  local pkgs="$1"
  shift
  local args="${*:-$pkgs}"
  if [ "$(uname -m)" = 'arm64' ] || [ "$(uname -m)" = 'aarch64' ]; then
    image="nixery.dev/arm64/shell/$pkgs"
  else
    image="nixery.dev/shell/$pkgs"
  fi
  name="${pkgs//\//-}"
  mkdir -p "/tmp/lima/$name"
  docker run --init -it --rm --name "$name" \
    --volume="/tmp/lima/$name:/tmp/lima/$name" \
    --workdir="/tmp/lima/$name" \
    "$image" $args
}

alias amass='nixery amass amass'
alias dalfox='nixery dalfox dalfox'
alias dnstwist='nixery dnstwist dnstwist'
alias dog='nixery dogdns dog'
alias ffuf='nixery ffuf ffuf'
alias gobuster='nixery gobuster gobuster'
alias hydra='nixery thc-hydra hydra'
alias katana='nixery katana katana'
alias k6='nixery k6 k6'
alias maigret='nixery maigret maigret'
alias msfconsole='nixery metasploit msfconsole'
alias naabu='nixery naabu naabu'
alias nikto='nixery nikto nikto'
alias nmap='nixery nmap nmap'
alias nuclei='nixery nuclei nuclei'
alias oha='nixery oha oha'
alias rustscan='nixery rustscan rustscan'
alias sqlmap='nixery sqlmap sqlmap'
alias tickrs='nixery tickrs tickrs --show-x-labels --summary -c candle -s'
alias wapiti='nixery wapiti wapiti'
alias webanalyze='nixery webanalyze webanalyze -update'
