#!/bin/sh

# configent (https://github.com/raas-dev/configent)
# One command automated macOS/Linux laptop/VM/container bootstrapper.
#
# Copyright(C) 2016- Anssi SyrjÃ¤salo (http://a.syrjasalo.com)
# Licensed under GNU Lesser General Public License v3 (LGPL-3.0).

trap "printf '\nCaught ^C from user - exiting now\n' ; exit 130" INT

this_path=$(cd "$(dirname "$0")" && pwd)
bin_path="$this_path/bin"
backup_path="$this_path/.backup"
config_path="$HOME/.config/configent"

: "${NO_SETUP:=""}"

"$bin_path/setup_fonts"

if command -v cursor >/dev/null; then
  if [ -z "$NO_SETUP" ]; then
    APP_NAME="Cursor" BIN_NAME="cursor" "$bin_path/setup_code"
  fi

  # Create Cursor mcp.json
  if [ ! -r "$backup_path/.cursor/mcp.json" ]; then
    if [ -r "$HOME/.cursor/mcp.json" ]; then
      mkdir -p "$backup_path/.cursor"
      cp -P "$HOME/.cursor/mcp.json" "$backup_path/.cursor/mcp.json"
    fi
  fi
  mkdir -p "$HOME/.cursor"
  ln -sfnv "$config_path/mcp/cursor_mcp.json" "$HOME/.cursor/mcp.json"

  # commands dir
  if [ ! -r "$backup_path/.cursor/commands" ]; then
    if [ -r "$HOME/.cursor/commands" ]; then
      mkdir -p "$backup_path/.cursor"
      cp -RP "$HOME/.cursor/commands" "$backup_path/.cursor/commands"
    fi
  fi
  mkdir -p "$HOME/.cursor/commands"
  rm -rf "$HOME/.cursor/commands"
  ln -sfnv "$config_path/commands" "$HOME/.cursor/commands"

  #APP_NAME="Cursor" BIN_NAME="cursor" "$bin_path/setup_kilocode"
fi

if command -v agy >/dev/null; then
  if [ -z "$NO_SETUP" ]; then
    APP_NAME="Antigravity" BIN_NAME="agy" "$bin_path/setup_code"
  fi

  # Create Antigravity mcp_config.json
  if [ ! -r "$backup_path/.gemini/antigravity/mcp_config.json" ]; then
    if [ -r "$HOME/.gemini/antigravity/mcp_config.json" ]; then
      mkdir -p "$backup_path/.gemini/antigravity"
      cp -P "$HOME/.gemini/antigravity/mcp_config.json" \
        "$backup_path/.gemini/antigravity/mcp_config.json"
    fi
  fi
  mkdir -p "$HOME/.gemini/antigravity"
  ln -sfnv "$config_path/mcp/antigravity_mcp.json" \
    "$HOME/.gemini/antigravity/mcp_config.json"

  #APP_NAME="Antigravity" BIN_NAME="agy" "$bin_path/setup_kilocode"
fi

if command -v code >/dev/null; then
  if [ -z "$NO_SETUP" ]; then
    APP_NAME="Code" BIN_NAME="code" "$bin_path/setup_code"
  fi

  # User-wide VS Code MCP configuration is in vscode/mcp.json

  #APP_NAME="Code" BIN_NAME="code" "$bin_path/setup_kilocode"
fi
